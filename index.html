import { useState } from "react";
import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";

const WORD_LENGTH = 5;
const MAX_GUESSES = 6;
const TARGET_WORD = "REACT";

export default function WordGame() {
  const [guesses, setGuesses] = useState([]);
  const [currentGuess, setCurrentGuess] = useState("");
  const [usedKeys, setUsedKeys] = useState({}); // Track keyboard colors

  const addLetter = (letter) => {
    if (currentGuess.length < WORD_LENGTH) {
      setCurrentGuess((prev) => prev + letter);
    }
  };

  const deleteLetter = () => {
    setCurrentGuess((prev) => prev.slice(0, -1));
  };

  const submitGuess = () => {
    if (currentGuess.length === WORD_LENGTH) {
      const newGuesses = [...guesses, currentGuess];
      setGuesses(newGuesses);
      updateKeyboardColors(currentGuess);
      setCurrentGuess("");
    }
  };

  const updateKeyboardColors = (word) => {
    const newColors = { ...usedKeys };
    for (let i = 0; i < WORD_LENGTH; i++) {
      const letter = word[i];
      if (TARGET_WORD[i] === letter) {
        newColors[letter] = "green";
      } else if (TARGET_WORD.includes(letter)) {
        if (newColors[letter] !== "green") newColors[letter] = "yellow";
      } else {
        if (!newColors[letter]) newColors[letter] = "gray";
      }
    }
    setUsedKeys(newColors);
  };

  const getBoxColor = (letter, index, word) => {
    if (!word) return "bg-gray-200 border-gray-300";
    if (TARGET_WORD[index] === letter)
      return "bg-green-500 text-white shadow-lg shadow-green-400";
    if (TARGET_WORD.includes(letter))
      return "bg-yellow-400 text-white shadow-lg shadow-yellow-300";
    return "bg-gray-500 text-white";
  };

  const getKeyColor = (letter) => {
    switch (usedKeys[letter]) {
      case "green":
        return "bg-green-500 text-white shadow shadow-green-400";
      case "yellow":
        return "bg-yellow-400 text-white shadow shadow-yellow-300";
      case "gray":
        return "bg-gray-400 text-white";
      default:
        return "bg-gray-200";
    }
  };

  const keyboardRows = [
    ["Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P"],
    ["A", "S", "D", "F", "G", "H", "J", "K", "L"],
    ["ENTER", "Z", "X", "C", "V", "B", "N", "M", "⌫"],
  ];

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-purple-200 p-6">
      {/* Title */}
      <motion.h1
        className="text-4xl font-bold mb-8 text-purple-800"
        initial={{ opacity: 0, y: -30 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.8 }}
      >
        Word Flip Game ✨
      </motion.h1>

      {/* Word Grid */}
      <div className="grid gap-2 mb-6">
        {[...Array(MAX_GUESSES)].map((_, row) => {
          const word =
            guesses[row] || (row === guesses.length ? currentGuess : "");
          return (
            <div key={row} className="flex gap-2 justify-center">
              {[...Array(WORD_LENGTH)].map((_, col) => {
                const letter = word[col] || "";
                const isSubmitted = row < guesses.length;
                return (
                  <motion.div
                    key={col}
                    className={`w-14 h-14 flex items-center justify-center rounded-xl font-bold text-2xl border-2 ${getBoxColor(
                      letter,
                      col,
                      isSubmitted ? word : null
                    )}`}
                    initial={false}
                    animate={{
                      rotateX: isSubmitted ? [0, 90, 0] : 0,
                      scale: letter ? [1, 1.1, 1] : 1,
                    }}
                    transition={{ duration: 0.6 }}
                  >
                    {letter}
                  </motion.div>
                );
              })}
            </div>
          );
        })}
      </div>

      {/* Touchscreen Keyboard */}
      <div className="flex flex-col gap-2">
        {keyboardRows.map((row, rIdx) => (
          <div key={rIdx} className="flex gap-1 justify-center">
            {row.map((key) => (
              <motion.div key={key} whileTap={{ scale: 0.85 }}>
                <Button
                  className={`px-3 py-2 rounded-md text-lg font-semibold ${getKeyColor(
                    key
                  )} transition-all duration-300 hover:brightness-110 active:scale-95`}
                  onClick={() => {
                    if (key === "ENTER") submitGuess();
                    else if (key === "⌫") deleteLetter();
                    else addLetter(key);
                  }}
                >
                  {key}
                </Button>
              </motion.div>
            ))}
          </div>
        ))}
      </div>
    </div>
  );
}
